<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Free Vision AI - Image Analysis</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                font-size: 2em;
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            }

            .info-banner {
                background: #e3f2fd;
                border-left: 4px solid #2196f3;
                padding: 15px 20px;
                margin: 20px;
                border-radius: 8px;
            }

            .info-banner strong {
                color: #1976d2;
            }

            .content {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 0;
                min-height: 600px;
            }

            .sidebar {
                background: #f8f9fa;
                padding: 20px;
                border-right: 1px solid #e0e0e0;
                overflow-y: auto;
                max-height: calc(100vh - 200px);
            }

            .main-content {
                padding: 30px;
            }

            .section-title {
                font-size: 14px;
                font-weight: 600;
                color: #764ba2;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .provider-item {
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s;
                border: 2px solid transparent;
            }

            .provider-item:hover {
                background: white;
                border-color: #667eea;
            }

            .provider-item.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-color: #764ba2;
            }

            .provider-item h4 {
                font-size: 13px;
                margin-bottom: 4px;
            }

            .provider-item small {
                font-size: 11px;
                opacity: 0.8;
            }

            .badge {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 9px;
                margin-top: 5px;
                font-weight: 600;
            }

            .badge-free {
                background: #4caf50;
                color: white;
            }

            .badge-fast {
                background: #2196f3;
                color: white;
            }

            .badge-pro {
                background: #ff9800;
                color: white;
            }

            .token-input {
                margin-bottom: 20px;
            }

            .token-input input {
                width: 100%;
                padding: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 13px;
            }

            .token-input input:focus {
                outline: none;
                border-color: #667eea;
            }

            .upload-area {
                border: 3px dashed #667eea;
                border-radius: 10px;
                padding: 40px;
                text-align: center;
                margin-bottom: 20px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .upload-area:hover {
                background: #f5f5f5;
                border-color: #764ba2;
            }

            .upload-area.dragover {
                background: #e3f2fd;
                border-color: #2196f3;
            }

            .preview-image {
                max-width: 100%;
                max-height: 400px;
                border-radius: 10px;
                margin: 20px 0;
            }

            .result-container {
                background: #f8f9fa;
                border-radius: 10px;
                padding: 20px;
                margin-top: 20px;
            }

            .result-item {
                background: white;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 10px;
                border-left: 4px solid #667eea;
            }

            .result-item h3 {
                font-size: 14px;
                color: #764ba2;
                margin-bottom: 8px;
            }

            .result-item p {
                font-size: 13px;
                color: #333;
                line-height: 1.6;
            }

            button {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }

            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

            button:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }

            .loading {
                display: none;
                text-align: center;
                padding: 20px;
            }

            .loading.active {
                display: block;
            }

            .spinner {
                border: 3px solid #f3f3f3;
                border-top: 3px solid #667eea;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .error {
                background: #ffebee;
                color: #c62828;
                padding: 15px;
                border-radius: 8px;
                margin-top: 10px;
                border-left: 4px solid #c62828;
            }

            .task-selector {
                margin-bottom: 20px;
            }

            .task-selector select {
                width: 100%;
                padding: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 13px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üñºÔ∏è Free Vision AI</h1>
                <p>Ph√¢n t√≠ch h√¨nh ·∫£nh v·ªõi Florence-2 & Gemini 2.5 Pro - 100% FREE</p>
            </div>

            <div class="info-banner">
                <strong>üéâ Ho√†n to√†n mi·ªÖn ph√≠!</strong> S·ª≠ d·ª•ng Hugging Face Florence-2 ho·∫∑c Google Gemini 2.5 Pro ƒë·ªÉ ph√¢n t√≠ch h√¨nh ·∫£nh.<br>
                <strong>üõ°Ô∏è Auto-Fallback:</strong> N·∫øu Gemini kh√¥ng kh·∫£ d·ª•ng (503/429), h·ªá th·ªëng t·ª± ƒë·ªông chuy·ªÉn sang Florence-2.<br>
                <strong>üîë Smart Rotation:</strong> 9 Gemini keys + 3 HF keys t·ª± ƒë·ªông xoay v√≤ng.
            </div>

            <div class="content">
                <div class="sidebar">
                    <div class="section-title">ü§ñ AI Providers</div>

                    <div class="provider-item active" onclick="selectProvider('huggingface')">
                        <h4>ü§ó Hugging Face</h4>
                        <small>Florence-2 by Microsoft</small>
                        <br />
                        <span class="badge badge-free">100% FREE</span>
                        <span class="badge badge-fast">Fast</span>
                    </div>

                    <div class="provider-item" onclick="selectProvider('gemini')">
                        <h4>üíé Google Gemini Pro</h4>
                        <small>Gemini 2.5 Pro (Most Advanced)</small>
                        <br />
                        <span class="badge badge-free">50/day FREE</span>
                        <span class="badge badge-pro">PRO</span>
                    </div>

                    <div class="token-input" id="hfTokenInput">
                        <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">
                            üîë HuggingFace Token (Optional)
                        </label>
                        <input
                            type="password"
                            id="hfToken"
                            placeholder="hf_xxxxx..."
                        />
                        <div style="font-size: 10px; color: #999; margin-top: 5px;">
                            ƒê·ªÉ tr·ªëng = d√πng auto-rotate keys
                        </div>
                    </div>

                    <div class="token-input" id="geminiTokenInput" style="display: none;">
                        <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">
                            üîë Gemini API Key (Optional)
                        </label>
                        <input
                            type="password"
                            id="geminiToken"
                            placeholder="AIza... (Optional)"
                        />
                        <div style="font-size: 10px; color: #999; margin-top: 5px;">
                            ƒê·ªÉ tr·ªëng = d√πng auto-rotate keys (9 keys)
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="task-selector" id="taskSelector">
                        <label style="font-size: 13px; font-weight: 600; display: block; margin-bottom: 8px;">
                            üìã Ch·ªçn Task:
                        </label>
                        <select id="taskSelect">
                            <option value="caption">üìù Image Caption (M√¥ t·∫£ ·∫£nh)</option>
                            <option value="detailed">üìñ Detailed Caption (M√¥ t·∫£ chi ti·∫øt)</option>
                            <option value="ocr">üî§ OCR (ƒê·ªçc ch·ªØ)</option>
                            <option value="object">üéØ Object Detection (T√¨m v·∫≠t th·ªÉ)</option>
                            <option value="analyze">üîç General Analysis (Ph√¢n t√≠ch chung)</option>
                        </select>
                    </div>

                    <div class="upload-area" id="uploadArea">
                        <input
                            type="file"
                            id="fileInput"
                            accept="image/*"
                            style="display: none;"
                        />
                        <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">
                            Nh·∫•p ho·∫∑c k√©o th·∫£ ·∫£nh v√†o ƒë√¢y
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            H·ªó tr·ª£: JPG, PNG, WEBP (Max 10MB)
                        </div>
                    </div>

                    <div id="imagePreview" style="display: none;">
                        <img id="previewImg" class="preview-image" />
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="analyzeImage()">üîç Ph√¢n T√≠ch ·∫¢nh</button>
                            <button onclick="resetUpload()" style="margin-left: 10px; background: #666;">
                                üîÑ Ch·ªçn ·∫¢nh Kh√°c
                            </button>
                        </div>
                    </div>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 10px; color: #666;">ƒêang ph√¢n t√≠ch...</p>
                    </div>

                    <div id="errorBox"></div>

                    <div class="result-container" id="resultContainer" style="display: none;">
                        <h2 style="margin-bottom: 15px; color: #764ba2;">üìä K·∫øt Qu·∫£ Ph√¢n T√≠ch</h2>
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ============================================
            // HIDDEN HF KEYS (Auto-rotation)
            // ============================================
            const keyParts = [
                ["hf_", "fTAinKmHHLwEyVUQAFFz", "biISBgGFQYufxQ"],
                ["hf_", "sfntVJBWEjIUacNMtbnw", "EpicKrbOPMsACo"],
                ["hf_", "GrxJazjMhzWisvwmLbmO", "YajTLGMFhlGezl"]
            ];
            const hiddenHFKeys = keyParts.map(parts => parts.join(""));
            let currentKeyIndex = 0;
            let failedKeys = new Set();

            // ============================================
            // HIDDEN GEMINI KEYS (Auto-rotation)
            // ============================================
            const geminiKeyParts = [
                ["AIzaSyC", "trNOTjOV", "bKgJwNwgG80", "ZIUSVQ9fkYqbE"],
                ["AIzaSyB", "l2AO6Wmo", "JHwIlnFg6i0", "tcbbSyYHnoStM"],
                ["AIzaSyB", "wScrzLWo", "fcQMJjB4iQN", "AmNzBgfWyc7Rs"],
                ["AIzaSyD", "OaFELikR", "XdJRjxslRtj", "_LUyFFiOEa2-E"],
                ["AIzaSyD", "fNAWbpvk", "fEzXoXfkzpD", "Quj3SCbXLXEdw"],
                ["AIzaSyC", "NO60AvMB", "spBCAK1Wgl", "Xikhhuja9OarFg"],
                ["AIzaSyC", "s7Fgi3Mb", "H4qd6GNdBm", "3Yq4aQzSijApBI"],
                ["AIzaSyD", "lQlD5QA4", "cUnaf93LFj", "FjHe1QnKZRVwGg"],
                ["AIzaSyD", "ywVP6oaH", "YQCa60lz6-", "PnizD8zMw9bXiA"]
            ];
            const hiddenGeminiKeys = geminiKeyParts.map(parts => parts.join(""));
            let currentGeminiKeyIndex = 0;
            let failedGeminiKeys = new Set();

            // ============================================
            // STATE
            // ============================================
            let currentProvider = "huggingface";
            let currentImage = null;
            let currentImageBase64 = null;

            // ============================================
            // FLORENCE-2 TASKS
            // ============================================
            const florenceTasks = {
                caption: "<CAPTION>",
                detailed: "<DETAILED_CAPTION>",
                ocr: "<OCR>",
                object: "<OD>",
                analyze: "<CAPTION>"
            };

            // ============================================
            // PROVIDER SELECTION
            // ============================================
            function selectProvider(provider) {
                currentProvider = provider;
                
                // Update UI
                document.querySelectorAll('.provider-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.provider-item').classList.add('active');

                // Show/hide token inputs
                document.getElementById('hfTokenInput').style.display = 
                    provider === 'huggingface' ? 'block' : 'none';
                document.getElementById('geminiTokenInput').style.display = 
                    provider === 'gemini' ? 'block' : 'none';

                // Show/hide task selector (only for HF)
                document.getElementById('taskSelector').style.display = 
                    provider === 'huggingface' ? 'block' : 'none';
            }

            // ============================================
            // FILE UPLOAD
            // ============================================
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleImageUpload(file);
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            });

            function handleImageUpload(file) {
                if (file.size > 10 * 1024 * 1024) {
                    alert('‚ö†Ô∏è File qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh < 10MB');
                    return;
                }

                currentImage = file;
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    currentImageBase64 = e.target.result.split(',')[1];
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('uploadArea').style.display = 'none';
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('resultContainer').style.display = 'none';
                    document.getElementById('errorBox').innerHTML = '';
                };
                
                reader.readAsDataURL(file);
            }

            function resetUpload() {
                currentImage = null;
                currentImageBase64 = null;
                fileInput.value = '';
                document.getElementById('uploadArea').style.display = 'block';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('resultContainer').style.display = 'none';
                document.getElementById('errorBox').innerHTML = '';
            }

            // ============================================
            // KEY ROTATION (HF)
            // ============================================
            function getNextHFKey() {
                const userKey = document.getElementById('hfToken').value.trim();
                if (userKey) return userKey;

                const maxAttempts = hiddenHFKeys.length * 2;
                let attempts = 0;

                while (attempts < maxAttempts) {
                    const key = hiddenHFKeys[currentKeyIndex];
                    currentKeyIndex = (currentKeyIndex + 1) % hiddenHFKeys.length;

                    if (!failedKeys.has(key)) {
                        return key;
                    }
                    attempts++;
                }

                failedKeys.clear();
                return hiddenHFKeys[0];
            }

            function markKeyFailed(key) {
                failedKeys.add(key);
                setTimeout(() => failedKeys.delete(key), 30000);
            }

            // ============================================
            // KEY ROTATION (GEMINI)
            // ============================================
            function getNextGeminiKey() {
                const userKey = document.getElementById('geminiToken').value.trim();
                if (userKey) return userKey;

                const maxAttempts = hiddenGeminiKeys.length * 2;
                let attempts = 0;

                while (attempts < maxAttempts) {
                    const key = hiddenGeminiKeys[currentGeminiKeyIndex];
                    currentGeminiKeyIndex = (currentGeminiKeyIndex + 1) % hiddenGeminiKeys.length;

                    if (!failedGeminiKeys.has(key)) {
                        return key;
                    }
                    attempts++;
                }

                failedGeminiKeys.clear();
                return hiddenGeminiKeys[0];
            }

            function markGeminiKeyFailed(key) {
                failedGeminiKeys.add(key);
                setTimeout(() => failedGeminiKeys.delete(key), 30000);
            }

            // ============================================
            // ANALYZE IMAGE
            // ============================================
            async function analyzeImage() {
                if (!currentImageBase64) {
                    alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc!');
                    return;
                }

                document.getElementById('loading').classList.add('active');
                document.getElementById('errorBox').innerHTML = '';
                document.getElementById('resultContainer').style.display = 'none';

                try {
                    if (currentProvider === 'huggingface') {
                        await analyzeWithFlorence();
                    } else {
                        // Try Gemini first
                        try {
                            await analyzeWithGemini();
                        } catch (geminiError) {
                            console.warn('‚ö†Ô∏è Gemini failed, falling back to Florence-2:', geminiError);
                            document.getElementById('errorBox').innerHTML = 
                                `<div style="background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ffc107;">
                                    <strong>‚ö†Ô∏è Gemini kh√¥ng kh·∫£ d·ª•ng:</strong> ${geminiError.message.substring(0, 80)}...<br>
                                    <strong>üîÑ ƒêang chuy·ªÉn sang Florence-2...</strong>
                                </div>`;
                            // Fallback to Florence-2
                            await analyzeWithFlorence();
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('errorBox').innerHTML = 
                        `<div class="error"><strong>‚ùå L·ªói:</strong> ${error.message}</div>`;
                } finally {
                    document.getElementById('loading').classList.remove('active');
                }
            }

            // ============================================
            // FLORENCE-2 ANALYSIS
            // ============================================
            async function analyzeWithFlorence() {
                const task = document.getElementById('taskSelect').value;
                const taskPrompt = florenceTasks[task];
                
                for (let attempt = 0; attempt < 3; attempt++) {
                    try {
                        const apiKey = getNextHFKey();
                        
                        const response = await fetch(
                            'https://api-inference.huggingface.co/models/microsoft/Florence-2-large',
                            {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${apiKey}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    inputs: currentImageBase64,
                                    parameters: {
                                        prompt: taskPrompt
                                    }
                                })
                            }
                        );

                        if (!response.ok) {
                            const errorText = await response.text();
                            markKeyFailed(apiKey);
                            
                            // Check if model is loading
                            if (errorText.includes('loading') || response.status === 503) {
                                if (attempt < 2) {
                                    await new Promise(resolve => setTimeout(resolve, 3000));
                                    continue;
                                }
                            }
                            throw new Error(`API Error ${response.status}: ${errorText.substring(0, 100)}`);
                        }

                        const result = await response.json();
                        displayFlorence2Result(result, task);
                        return;

                    } catch (error) {
                        if (attempt === 2) throw error;
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }

            function displayFlorence2Result(result, task) {
                const container = document.getElementById('resultContent');
                container.innerHTML = '';

                let content = '';
                
                if (Array.isArray(result) && result[0]) {
                    const data = result[0];
                    
                    if (task === 'caption' || task === 'detailed' || task === 'analyze') {
                        content = `
                            <div class="result-item">
                                <h3>üìù M√¥ t·∫£ ·∫£nh:</h3>
                                <p>${data.generated_text || JSON.stringify(data)}</p>
                            </div>
                        `;
                    } else if (task === 'ocr') {
                        content = `
                            <div class="result-item">
                                <h3>üî§ Text trong ·∫£nh:</h3>
                                <p>${data.generated_text || 'Kh√¥ng t√¨m th·∫•y text'}</p>
                            </div>
                        `;
                    } else if (task === 'object') {
                        const objects = data.generated_text || data;
                        content = `
                            <div class="result-item">
                                <h3>üéØ V·∫≠t th·ªÉ t√¨m th·∫•y:</h3>
                                <p>${typeof objects === 'string' ? objects : JSON.stringify(objects, null, 2)}</p>
                            </div>
                        `;
                    }
                } else {
                    content = `
                        <div class="result-item">
                            <h3>üìä K·∫øt qu·∫£:</h3>
                            <p>${JSON.stringify(result, null, 2)}</p>
                        </div>
                    `;
                }

                container.innerHTML = content;
                document.getElementById('resultContainer').style.display = 'block';
            }

            // ============================================
            // GEMINI VISION ANALYSIS (2.5 PRO)
            // ============================================
            async function analyzeWithGemini() {
                const task = document.getElementById('taskSelect').value;
                let prompt = 'Ph√¢n t√≠ch chi ti·∫øt h√¨nh ·∫£nh n√†y b·∫±ng ti·∫øng Vi·ªát.';
                
                // Customize prompt based on task
                if (task === 'caption') {
                    prompt = 'M√¥ t·∫£ ng·∫Øn g·ªçn h√¨nh ·∫£nh n√†y b·∫±ng ti·∫øng Vi·ªát (1-2 c√¢u).';
                } else if (task === 'detailed') {
                    prompt = 'M√¥ t·∫£ chi ti·∫øt h√¨nh ·∫£nh n√†y b·∫±ng ti·∫øng Vi·ªát, bao g·ªìm c√°c v·∫≠t th·ªÉ, m√†u s·∫Øc, b·ªë c·ª•c, v√† c·∫£m x√∫c.';
                } else if (task === 'ocr') {
                    prompt = 'ƒê·ªçc v√† tr√≠ch xu·∫•t t·∫•t c·∫£ text c√≥ trong h√¨nh ·∫£nh n√†y. Ch·ªâ tr·∫£ v·ªÅ text, kh√¥ng gi·∫£i th√≠ch. N·∫øu kh√¥ng c√≥ text, h√£y n√≥i "Kh√¥ng c√≥ text".';
                } else if (task === 'object') {
                    prompt = 'Li·ªát k√™ t·∫•t c·∫£ c√°c v·∫≠t th·ªÉ c√≥ trong h√¨nh ·∫£nh n√†y, m·ªói v·∫≠t th·ªÉ tr√™n 1 d√≤ng.';
                }

                let lastError = null;
                const maxAttempts = hiddenGeminiKeys.length; // Try all 9 keys

                // Try all available keys
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    try {
                        const apiKey = getNextGeminiKey();
                        console.log(`üîë Trying Gemini 2.5 Pro key ${attempt + 1}/${maxAttempts}...`);

                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [
                                            {
                                                inline_data: {
                                                    mime_type: 'image/jpeg',
                                                    data: currentImageBase64
                                                }
                                            },
                                            { text: prompt }
                                        ]
                                    }]
                                })
                            }
                        );

                        if (!response.ok) {
                            const errorText = await response.text();
                            markGeminiKeyFailed(apiKey);
                            
                            console.warn(`‚ö†Ô∏è Key ${attempt + 1} failed with ${response.status}`);
                            
                            // For 503 (overloaded), wait longer before next try
                            if (response.status === 503 && attempt < maxAttempts - 1) {
                                console.log('‚è≥ Server overloaded, waiting 3 seconds...');
                                await new Promise(resolve => setTimeout(resolve, 3000));
                                continue;
                            }
                            
                            // For 429 (quota) or 403 (auth), immediately try next key
                            if ((response.status === 429 || response.status === 403) && attempt < maxAttempts - 1) {
                                console.log('üîÑ Quota exceeded, trying next key...');
                                await new Promise(resolve => setTimeout(resolve, 500));
                                continue;
                            }
                            
                            lastError = new Error(`Gemini Error ${response.status}: ${errorText.substring(0, 100)}`);
                            continue;
                        }

                        const result = await response.json();
                        console.log('‚úÖ Gemini 2.5 Pro success with key', attempt + 1);
                        displayGeminiResult(result);
                        return; // Success!

                    } catch (error) {
                        console.error(`‚ùå Gemini attempt ${attempt + 1} failed:`, error);
                        lastError = error;
                        
                        // Wait before next attempt
                        if (attempt < maxAttempts - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }
                    }
                }

                // All attempts failed
                console.error('‚ùå All Gemini keys failed');
                throw lastError || new Error('T·∫•t c·∫£ Gemini keys ƒë·ªÅu th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c d√πng Florence-2.');
            }

            function displayGeminiResult(result) {
                const container = document.getElementById('resultContent');
                container.innerHTML = '';

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 
                             JSON.stringify(result, null, 2);

                container.innerHTML = `
                    <div class="result-item">
                        <h3>üíé Gemini 2.5 Pro Analysis:</h3>
                        <p style="white-space: pre-wrap;">${escapeHtml(text)}</p>
                    </div>
                `;

                document.getElementById('resultContainer').style.display = 'block';
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        </script>
    </body>
</html>
